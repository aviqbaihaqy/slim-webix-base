{% embed "layouts/blank_backend.twig" with {'current_pages' : 'User List'} %}

{% block title %}{{config['site-name']}} || User Management{% endblock %}

{% block container %}

<div class="row">
    <div class="col-lg-12">

      <div class="card">
          <div class="card-header">
              User Account
              <div class="float-right mb-0">
                  <a href="{{ path_for('admin-users-add') }}" class="btn btn-sm btn-success"><span class="fa fa-fw fa-plus"></span> Add User</a>
              </div>
          </div>
          <div class="card-body">
            <div id='grid-container'></div>
          </div>
      </div>
    </div>
</div>

{% if auth.hasAccess('role.view') %}
<div class="row">
    <div class="col-md-6">
      <div class="card">
          <div class="card-header">
              User Roles
          </div>
          <div class="card-body">
            <table class="table table-responsive-sm table-bordered table-striped table-sm" id="roles_table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Slug</th>
                        <th>Permissions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for role in roles %}
                        <tr>
                            <td>{{ role.name }}</td>
                            <td>{{ role.slug }}</td>
                            <td>
                                {% for key, perm in role.permissions | json_decode %}
                                    {% if perm == 1 %}
                                        {{key}}
                                    {% else %}
                                        <span style="color: red;">{{key}}</span>
                                    {% endif %}
                                    {% if not loop.last %},{% endif %}
                                {% endfor %}
                            </td>
                            <td>
                                {% if auth.hasAccess('role.update') %}
                                    <a href="{{ path_for('admin-roles-edit', {'role': role.id}) }}" class="btn btn-primary btn-xs">
                                        <span class="fa fa-fw fa-pencil"></span>
                                    </a>
                                {% endif %}
                                {% if auth.hasAccess('role.delete') %}
                                    {% if role.id != 1 %}
                                        <form action="{{ path_for('admin-roles-delete') }}" method="post" style="display: inline;">
                                            <input type="hidden" name="role_id" value="{{ role.id }}"/>
                                            {{csrf()}}
                                            <button class="btn btn-danger btn-xs swal-confirm" data-swtitle="Are you sure?" data-swmessage="This role will be permanently removed from all users and you will not be able to undo it!">
                                                <span class="fa fa-fw fa-close"></span>
                                            </button>
                                        </form>

                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
          </div>
      </div>
    </div>
    {% endif %}

    {% if auth.hasAccess('role.create') %}
    <div class="col-md-6">
      <div class="card">
          <div class="card-header">
               Add User Role
          </div>
          <div class="card-body">
            <form action="{{ path_for('admin-roles-add') }}" method="POST" role="form">

                <div class="form-group col-md-6">
                    <label for="">Name</label>
                    <input type="text" name="role_name" class="form-control" id="role_name" placeholder="Role Name">
                </div>

                <div class="form-group col-md-6">
                    <label for="">Slug</label>
                    <input type="text" name="role_slug" class="form-control" id="role_slug" placeholder="Role Slug">
                </div>

                <div class="form-group col-md-4 col-md-offset-4">
                    <button type="submit" class="btn btn-primary btn-primary form-control">Add Role
                        <span class="fa fa-fw fa-arrow-right"></span></button>
                </div>
                {{ csrf() }}
            </form>
          </div>
      </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block after_script %} {{ parent() }}
<script>
  webix.ready(function () {
    var grid = webix.ui({
      container: "grid-container",
      view: "datatable",
      id: "grid",
      minHeight: 600,
      dataFeed: true,
      columns: [
        { id: "index", header: "#", sort: "int", width: 50 },
        { id: "first_name", header: ["firstname", { content: "serverFilter" }], sort: "server", fillspace: 2 },
        { id: "last_name", header: ["lastname", { content: "serverFilter" }], sort: "server", fillspace: 3 },
        { id: "email", header: "email", fillspace: 2 },
        { id: "username", header: "username", fillspace: 2 },
        { id: "permission", header: "role", fillspace: 2 },
        { id: "edit", header: "&nbsp;", width: 35, template: function(obj){
          return decor.btnIconEdit(obj.link.edit, obj.id, {{auth.hasAccess('user.edit')}})
        }},
        { id: "delete", header: "&nbsp;", template: function(obj){
          return decor.btnIconRemove(obj.id , {{auth.hasAccess('user.delete')}});
        }}
      ],
      url: "{{ path_for('admin-users',{}, {'format':'json'}) }}",
      ready: handle.emptydata,
      on: {
        onBeforeLoad: handle.onBeforeLoad,
        onAfterLoad: handle.onAfterLoad,
        "data->onStoreUpdated": handle.numbering
      },
      onClick: {
        "fa-trash-o": function (e, id, node) {
          handle.onBeforeDelete(e, id, node, 'grid');
        }
      },

    });

    webix.event(window, "resize", function () { grid.adjust(); });
    var csrf = {
      'nameKey' :  "{{csrf.nameKey}}",
      'valueKey' : "{{csrf.valueKey}}",
      'tokenName' : "{{ csrf.tokenName}}",
      'tokenValue' : "{{ csrf.tokenValue}}"
    };

    var dp = new webix.DataProcessor({
      updateFromResponse: true,
      autoupdate: true,
      master: $$("grid"),
      url: "slim->{{ path_for('admin-users-delete') }}",
    });

    dp.attachEvent("onBeforeDelete", function (id, object) {
      object.data.{{csrf.nameKey}} = "{{ csrf.tokenName}}";
      object.data.{{csrf.valueKey}} = "{{ csrf.tokenValue}}";
    });

    dp.attachEvent('onAfterSync', function (statusObj, text, data, xhr) {
      webix.alert({
        title: "Sukses",
        text: "Data berhasil dihapus",
        type: "alert-success"
      });

      var header = JSON.parse(xhr.getResponseHeader('X-CSRF-Token'));
      {{csrf.nameKey}} = header.csrf_name;
      {{csrf.valueKey}} = header.csrf_value;
    });

  });

</script> {% endblock %}

{% endembed %}


